/*
James Cryer / Huddle
URL: https://github.com/Huddle/Resemble.js
*/
!function(e,t){"use strict";"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&module.exports?module.exports=t():e.resemble=t()}(this,(function(){"use strict";var e,t;"undefined"!=typeof Image?e=Image:(t=require("canvas-prebuilt"),e=t.Image);var r="undefined"!=typeof window?window.document:{createElement:function(){return new t}},n={},i=n;var o=function(t){var o=1,a={red:255,green:0,blue:255,alpha:255},u={r:0,g:0,b:0,a:0};function f(e,t){return(Math.abs(e.r-t.r)+Math.abs(e.g-t.g)+Math.abs(e.b-t.b))/3}function s(e,t,r,n,i){return e>(i.left||0)&&e<(i.right||r)&&t>(i.top||0)&&t<(i.bottom||n)}var h,g,l,c={flat:function(e,t){e[t]=a.red,e[t+1]=a.green,e[t+2]=a.blue,e[t+3]=a.alpha},movement:function(e,t,r,n){e[t]=(n.r*(a.red/255)+a.red)/2,e[t+1]=(n.g*(a.green/255)+a.green)/2,e[t+2]=(n.b*(a.blue/255)+a.blue)/2,e[t+3]=n.a},flatDifferenceIntensity:function(e,t,r,n){e[t]=a.red,e[t+1]=a.green,e[t+2]=a.blue,e[t+3]=f(r,n)},movementDifferenceIntensity:function(e,t,r,n){var i=f(r,n)/255*.8;e[t]=(1-i)*(n.r*(a.red/255))+i*a.red,e[t+1]=(1-i)*(n.g*(a.green/255))+i*a.green,e[t+2]=(1-i)*(n.b*(a.blue/255))+i*a.blue,e[t+3]=n.a},diffOnly:function(e,t,r,n){e[t]=n.r,e[t+1]=n.g,e[t+2]=n.b,e[t+3]=n.a}},d=c.flat,m=1200,b=!0,p={},v=[],w=[],y={red:16,green:16,blue:16,alpha:16,minBrightness:16,maxBrightness:240},x=!1,B=!1,M=!1;function I(){var e,t=w.length;for(e=0;e<t;e++)"function"==typeof w[e]&&w[e](p)}function D(e,t,r){var n,i;for(n=0;n<e;n++)for(i=0;i<t;i++)r(n,i)}function S(t,n){var i,o=new e;o.setAttribute||(o.setAttribute=function(){}),b&&o.setAttribute("crossorigin","anonymous"),o.onerror=function(e){o.onload=null,o.onerror=null,v.push({error:e?e+"":"Image load error."}),n()},o.onload=function(){o.onload=null,o.onerror=null;var e,t=r.createElement("canvas"),i=o.width,a=o.height;M&&1===v.length&&(i=v[0].width,a=v[0].height),t.width=i,t.height=a,t.getContext("2d").drawImage(o,0,0,i,a),e=t.getContext("2d").getImageData(0,0,i,a),v.push(e),n(e,i,a)},"string"==typeof t?(o.src=t,o.complete&&o.naturalWidth>0&&o.onload()):void 0!==t.data&&"number"==typeof t.width&&"number"==typeof t.height?(v.push(t),n(t,t.width,t.height)):"undefined"!=typeof Buffer&&t instanceof Buffer?o.src=t:((i=new FileReader).onload=function(e){o.src=e.target.result},i.readAsDataURL(t))}function C(e,t,r){var n=Math.abs(e-t);return void 0!==e&&(void 0!==t&&(e===t||n<y[r]))}function T(e,t){var r=C(e.a,t.a,"alpha");return C(e.brightness,t.brightness,"minBrightness")&&r}function k(e,t,r){return.3*e+.59*t+.11*r}function A(e,t){var r=e.r===t.r,n=e.g===t.g,i=e.b===t.b;return r&&n&&i}function E(e,t,r,n,i,o){var a,f,s,h,g=0,l=0,c=0;for(R(e),a=-1;a<=1;a++)for(f=-1;f<=1;f++)if(0===a&&0===f);else{if(!P(u,t,4*((n+f)*o+(i+a))))continue;if(N(u),R(u),s=e,h=u,Math.abs(s.brightness-h.brightness)>y.maxBrightness&&g++,A(e,u)&&c++,Math.abs(u.h-e.h)>.3&&l++,l>1||g>1)return!0}return c<2}function O(e,t,r){"diffOnly"!==h&&(e[t]=r.brightness,e[t+1]=r.brightness,e[t+2]=r.brightness,e[t+3]=r.a*o)}function P(e,t,r){return t.length>r&&(e.r=t[r],e.g=t[r+1],e.b=t[r+2],e.a=t[r+3],!0)}function N(e){e.brightness=k(e.r,e.g,e.b)}function R(e){e.h=function(e,t,r){var n,i,o=e/255,a=t/255,u=r/255,f=Math.max(o,a,u),s=Math.min(o,a,u);if(f===s)n=0;else switch(i=f-s,f){case o:n=(a-u)/i+(a<u?6:0);break;case a:n=(u-o)/i+2;break;case u:n=(o-a)/i+4;break;default:n/=6}return n}(e.r,e.g,e.b)}function z(e,t,n,i){var a=r.createElement("canvas"),u=e.data,f=t.data;a.width=n,a.height=i;var c,b=a.getContext("2d"),v=b.createImageData(n,i),w=v.data,y=0,M={top:i,left:n,bottom:0,right:0},I=function(e,t){M.left=Math.min(e,M.left),M.right=Math.max(e,M.right),M.top=Math.min(t,M.top),M.bottom=Math.max(t,M.bottom)},S=Date.now();m&&x&&(n>m||i>m)&&(c=6);var k={r:0,g:0,b:0,a:0},A={r:0,g:0,b:0,a:0};D(n,i,(function(e,t){if(!c||t%c!=0&&e%c!=0){var r,a,m,b,p,v,M=4*(t*n+e),D=function(e,t,r,n){var i=!0;return void 0===g||s(e,t,r,n,g)||(i=!1),void 0!==l&&s(e,t,r,n,l)&&(i=!1),i}(e,t,n,i);if(P(k,u,M)&&P(A,f,M))return B?(N(k),N(A),void(T(k,A)||!D?O(w,M,A):(d(w,M,k,A),y++,I(e,t)))):(m=C((r=k).r,(a=A).r,"red"),b=C(r.g,a.g,"green"),p=C(r.b,a.b,"blue"),v=C(r.a,a.a,"alpha"),void(m&&b&&p&&v||!D?function(e,t,r){"diffOnly"!==h&&(e[t]=r.r,e[t+1]=r.g,e[t+2]=r.b,e[t+3]=r.a*o)}(w,M,k):x&&(N(k),N(A),E(k,u,0,t,e,n)||E(A,f,0,t,e,n))&&(T(k,A)||!D)?O(w,M,A):(d(w,M,k,A),y++,I(e,t))))}})),p.rawMisMatchPercentage=y/(i*n)*100,p.misMatchPercentage=p.rawMisMatchPercentage.toFixed(2),p.diffBounds=M,p.analysisTime=Date.now()-S,p.getImageDataUrl=function(e){var t=0;return e&&(t=function(e,t,r){t.font="12px sans-serif";var n=t.measureText(e).width+4;n>r.width&&(r.width=n);return r.height+=22,t.fillStyle="#666",t.fillRect(0,0,r.width,18),t.fillStyle="#fff",t.fillRect(0,18,r.width,4),t.fillStyle="#fff",t.textBaseline="top",t.font="12px sans-serif",t.fillText(e,2,1),22}(e,b,a)),b.putImageData(v,0,t),a.toDataURL("image/png")},a.toBuffer&&(p.getBuffer=function(r){if(r){var n=a.width+2;a.width=3*n,b.putImageData(e,0,0),b.putImageData(t,n,0),b.putImageData(v,2*n,0)}else b.putImageData(v,0,0);return a.toBuffer()})}function L(e,t,n){var i,o;return e.height<n||e.width<t?((i=r.createElement("canvas")).width=t,i.height=n,(o=i.getContext("2d")).putImageData(e,0,0),o.getImageData(0,0,t,n)):e}function U(e){var t;if(e.errorColor)for(t in e.errorColor)e.errorColor.hasOwnProperty(t)&&(a[t]=void 0===e.errorColor[t]?a[t]:e.errorColor[t]);e.errorType&&c[e.errorType]&&(d=c[e.errorType],h=e.errorType),e.errorPixel&&"function"==typeof e.errorPixel&&(d=e.errorPixel),o=isNaN(Number(e.transparency))?o:e.transparency,void 0!==e.largeImageThreshold&&(m=e.largeImageThreshold),void 0!==e.useCrossOrigin&&(b=e.useCrossOrigin),void 0!==e.boundingBox&&(g=e.boundingBox),void 0!==e.ignoredBox&&(l=e.ignoredBox)}function F(e){var r,o="function"==typeof e;o||(r=e);var a={scaleToSameSize:function(){return M=!0,o&&e(),a},useOriginalSize:function(){return M=!1,o&&e(),a},ignoreNothing:function(){return y.red=0,y.green=0,y.blue=0,y.alpha=0,y.minBrightness=0,y.maxBrightness=255,x=!1,B=!1,o&&e(),a},ignoreLess:function(){return y.red=16,y.green=16,y.blue=16,y.alpha=16,y.minBrightness=16,y.maxBrightness=240,x=!1,B=!1,o&&e(),a},ignoreAntialiasing:function(){return y.red=32,y.green=32,y.blue=32,y.alpha=32,y.minBrightness=64,y.maxBrightness=96,x=!0,B=!1,o&&e(),a},ignoreColors:function(){return y.alpha=16,y.minBrightness=16,y.maxBrightness=240,x=!1,B=!0,o&&e(),a},ignoreAlpha:function(){return y.red=16,y.green=16,y.blue=16,y.alpha=255,y.minBrightness=16,y.maxBrightness=240,x=!1,B=!1,o&&e(),a},repaint:function(){return o&&e(),a},outputSettings:function(e){return U(e),a},onComplete:function(e){w.push(e);var o=function(){!function(e,t){function r(){var e,t;if(2===v.length){if(v[0].error||v[1].error)return(p={}).error=v[0].error?v[0].error:v[1].error,void I();e=v[0].width>v[1].width?v[0].width:v[1].width,t=v[0].height>v[1].height?v[0].height:v[1].height,v[0].width===v[1].width&&v[0].height===v[1].height?p.isSameDimensions=!0:p.isSameDimensions=!1,p.dimensionDifference={width:v[0].width-v[1].width,height:v[0].height-v[1].height},z(L(v[0],e,t),L(v[1],e,t),e,t),I()}}i!==n&&U(i),v=[],S(e,r),S(t,r)}(t,r)};return o(),F(o)}};return a}var j={onComplete:function(e){w.push(e),S(t,(function(e,t,r){!function(e,t,r){var n=0,i=0,o=0,a=0,u=0,f=0,s=0,h=0;D(t,r,(function(r,g){var l=4*(g*t+r),c=e[l],d=e[l+1],m=e[l+2],b=e[l+3],p=k(c,d,m);c===d&&c===m&&b&&(0===c?h++:255===c&&s++),n++,i+=c/255*100,o+=d/255*100,a+=m/255*100,u+=(255-b)/255*100,f+=p/255*100})),p.red=Math.floor(i/n),p.green=Math.floor(o/n),p.blue=Math.floor(a/n),p.alpha=Math.floor(u/n),p.brightness=Math.floor(f/n),p.white=Math.floor(s/n*100),p.black=Math.floor(h/n*100),I()}(e.data,t,r)}))},compareTo:function(e){return F(e)},outputSettings:function(e){return U(e),j}};return j};function a(e,t){switch(t){case"nothing":e.ignoreNothing();break;case"less":e.ignoreLess();break;case"antialiasing":e.ignoreAntialiasing();break;case"colors":e.ignoreColors();break;case"alpha":e.ignoreAlpha();break;default:throw new Error("Invalid ignore: "+t)}}return o.compare=function(e,t,r,n){var i,u;"function"==typeof r?(i=r,u={}):(i=n,u=r||{});var f,s=o(e);u.output&&s.outputSettings(u.output),f=s.compareTo(t),u.scaleToSameSize&&f.scaleToSameSize(),"string"==typeof u.ignore?a(f,u.ignore):u.ignore&&u.ignore.forEach&&u.ignore.forEach((function(e){a(f,e)})),f.onComplete((function(e){e.error?i(e.error):i(null,e)}))},o.outputSettings=function(e){return console.warn("warning resemble.outputSettings mutates global state, and will be removed in 3.0.0"),i=e,this},o}));